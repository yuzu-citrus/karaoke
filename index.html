// GAS Webアプリケーションのコード

// ★★★ ここにあなたのスプレッドシートIDを直接記述します ★★★
const SPREADSHEET_ID = '1bv0FVC9tHVTfwEnzLMlZwflXa_oeibwGir1fArQpmr8'; 

const SHEET_NAME = 'シート1'; // 必要であればシート名を変更してください

/**
 * POSTリクエストを処理する関数（Webアプリケーションとして実行される）
 * Chrome拡張機能からデータを受け取ります。
 * @param {Object} e - イベントオブジェクト。POSTデータが含まれます。
 * @returns {GoogleAppsScript.Content.TextOutput} - JSON形式のレスポンス
 */
function doPost(e) {
  const responseOutput = ContentService.createTextOutput();
  responseOutput.setMimeType(ContentService.MimeType.JSON);

  const postDataContents = (e && e.postData) ? e.postData.contents : null;

  if (!postDataContents) {
    console.warn("たは無効なリクエストボディが届きました。イベントオブジェクト:", JSON.stringify(e));
    return createJsonResponse(false, "リクエストボディが空または無効です。", 400);
  }

  let data;
  try {
    data = JSON.parse(postDataContents);
  } catch (error) {
    console.error("JSONパースエラー:", error);
    return createJsonResponse(false, "リクエストボディのJSONパースに失敗しました。", 400);
  }

  // スプレッドシートIDはGASコード内で定義済みのため、リクエストボディからは取得しません。
  const name = data.name;
  const room = data.room;
  const actionType = data.actionType;
  const currentTime = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');

  // パラメータのバリデーション
  if (!name || !room || !actionType) {
    return createJsonResponse(false, "氏名、部屋番号、アクションタイプは必須です。", 400);
  }
  // GASコードに直接記述されたSPREADSHEET_IDが正しいか最終確認することも可能ですが、通常は不要です。

  try {
    // ★★★ GASコード内で定義されたSPREADSHEET_IDを使用します ★★★
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);

    if (!sheet) {
      return createJsonResponse(false, `シート名「${SHEET_NAME}」が見つかりません。`, 404);
    }

    if (actionType === 'enter') {
      sheet.appendRow([name, room, currentTime, '', '']);
      return createJsonResponse(true, `${name}様が${room}に入室しました。`);
    } else if (actionType === 'exit') {
      const dataRange = sheet.getDataRange();
      const values = dataRange.getValues();

      let foundRowIndex = -1;
      for (let i = values.length - 1; i >= 1; i--) {
        const row = values[i];
        if (row[0] === name && row[1] === room && (row[3] === '' || row[3] === undefined)) {
          foundRowIndex = i + 1;
          break;
        }
      }

      if (foundRowIndex !== -1) {
        sheet.getRange(foundRowIndex, 4).setValue(currentTime);
        return createJsonResponse(true, `${name}様が${room}から退室しました。`);
      } else {
        return createJsonResponse(false, `${name}様が${room}に入室中の記録が見つかりません。`);
      }
    } else {
      return createJsonResponse(false, "無効なアクションタイプです。'enter'または'exit'を指定してください。", 400);
    }

  } catch (error) {
    // SpreadsheetApp.openById() でIDが見つからない場合もここでキャッチされます
    if (error.message.includes("Can't find spreadsheet") || error.message.includes("Invalid argument: id")) {
      console.error("スプレッドシートが見つからないか、IDが無効です:", SPREADSHEET_ID, error);
      return createJsonResponse(false, `サーバー設定エラー: 指定されたスプレッドシートIDが無効か、見つかりません。`, 500);
    }
    console.error("スクリプト実行エラー:", error);
    return createJsonResponse(false, `サーバーエラーが発生しました: ${error.message}`, 500);
  }
}

/**
 * JSON形式のレスポンスを作成するヘルパー関数
 * @param {boolean} success - 処理が成功したかどうか
 * @param {string} message - ユーザーへのメッセージ
 * @param {number} statusCode - HTTPステータスコード (任意, GASでは直接設定できないがログ用)
 * @returns {GoogleAppsScript.Content.TextOutput}
 */
function createJsonResponse(success, message, statusCode = 200) {
  const json = JSON.stringify({ success: success, message: message, statusCode: statusCode });
  return ContentService.createTextOutput(json)
                       .setMimeType(ContentService.MimeType.JSON);
}
