<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuzu Karaoke Room Management</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 0 20px; }
        .room-section { margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
        .room-section h2 { margin-top: 0; }
        .room-section button { margin-right: 10px; padding: 8px 15px; cursor: pointer; }
        .room-status { margin-top: 15px; font-size: 1.1em; }
        .room-status.occupied { color: red; font-weight: bold; }
        .room-status.vacant { color: green; }
        #overall-status { margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 20px; }
        #overall-status h2 { text-align: center; }
        .room-display { display: inline-block; margin: 10px; padding: 10px; border: 1px solid #eee; border-radius: 5px; text-align: center; width: 100px; }
        .room-display.occupied { background-color: #ffe0e0; border-color: #ffaaaa; }
        .room-display.vacant { background-color: #e0ffe0; border-color: #aaffaa; }
    </style>
</head>
<body>
    <h1>カラオケ部屋管理</h1>

    <div class="room-section">
        <label for="userName">名前:</label>
        <input type="text" id="userName" placeholder="あなたの名前" required>
    </div>

    <div class="room-section">
        <h2>部屋A</h2>
        <button onclick="handleRoomAction('A', 'entry')">入室</button>
        <button onclick="handleRoomAction('A', 'exit')">退室</button>
        <p id="roomAStatus" class="room-status">現在の状態: 取得中...</p>
    </div>

    <div class="room-section">
        <h2>部屋B</h2>
        <button onclick="handleRoomAction('B', 'entry')">入室</button>
        <button onclick="handleRoomAction('B', 'exit')">退室</button>
        <p id="roomBStatus" class="room-status">現在の状態: 取得中...</p>
    </div>

    <div class="room-section">
        <h2>部屋C</h2>
        <button onclick="handleRoomAction('C', 'entry')">入室</button>
        <button onclick="handleRoomAction('C', 'exit')">退室</button>
        <p id="roomCStatus" class="room-status">現在の状態: 取得中...</p>
    </div>

    <div class="room-section">
        <h2>部屋D</h2>
        <button onclick="handleRoomAction('D', 'entry')">入室</button>
        <button onclick="handleRoomAction('D', 'exit')">退室</button>
        <p id="roomDStatus" class="room-status">現在の状態: 取得中...</p>
    </div>

    <div class="room-section">
        <h2>部屋E</h2>
        <button onclick="handleRoomAction('E', 'entry')">入室</button>
        <button onclick="handleRoomAction('E', 'exit')">退室</button>
        <p id="roomEStatus" class="room-status">現在の状態: 取得中...</p>
    </div>

    <div id="overall-status">
        <h2>部屋全体の状況</h2>
        <div id="statusDisplays">
            </div>
        <button onclick="fetchRoomStatus()">状況を更新</button>
    </div>

    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwiQu0ekeOfKRIaU1jBeaTfL0ozoG9VHcc9XrG9s-HtzAAO2N6NyGGYluS1HfnsfuU/exec'; // ★ここをGASのウェブアプリURLに置き換える

        // 部屋のアクション（入室/退室）を処理する
        async function handleRoomAction(room, action) {
            const userNameInput = document.getElementById('userName');
            const userName = userNameInput.value.trim();

            if (!userName) {
                alert('名前を入力してください。');
                return;
            }

            if (!confirm(`${userName}さんが部屋${room}に${action === 'entry' ? '入室' : '退室'}しますか？`)) {
                return;
            }

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors', // CORSを有効にする
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: userName,
                        room: room,
                        action: action,
                    }),
                });

                const data = await response.json();
                if (data.status === 'success') {
                    alert(`${room}への${action === 'entry' ? '入室' : '退室'}を記録しました！\n時間: ${new Date(data.timestamp).toLocaleString('ja-JP')}`);
                    fetchRoomStatus(); // 記録後に最新の状況を更新
                } else {
                    alert(`エラー: ${data.message}`);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert('通信エラーが発生しました。ネットワーク接続を確認してください。');
            }
        }

        // 各部屋の現在の状態を取得し表示する
        async function fetchRoomStatus() {
            try {
                // 各部屋の個別のステータス表示をリセット
                ['A', 'B', 'C', 'D', 'E'].forEach(room => {
                    const statusElem = document.getElementById(`room${room}Status`);
                    if (statusElem) {
                        statusElem.textContent = '現在の状態: 取得中...';
                        statusElem.className = 'room-status'; // クラスをリセット
                    }
                });

                // 全体の状況表示をクリア
                const statusDisplaysContainer = document.getElementById('statusDisplays');
                statusDisplaysContainer.innerHTML = '';


                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'GET', // GETリクエスト
                    mode: 'cors',
                });

                const data = await response.json();
                if (data.status === 'success' && data.rooms) {
                    const roomOrder = ['A', 'B', 'C', 'D', 'E']; // 表示順を制御
                    roomOrder.forEach(room => {
                        const roomInfo = data.rooms[room];
                        const statusText = roomInfo.status === 'occupied' ?
                            `使用中 (${roomInfo.currentOccupant || '不明'} - ${new Date(roomInfo.entryTime).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})}入室)` :
                            '空室';
                        const statusClass = roomInfo.status === 'occupied' ? 'occupied' : 'vacant';

                        // 各部屋の個別のステータス表示を更新
                        const statusElem = document.getElementById(`room${room}Status`);
                        if (statusElem) {
                            statusElem.textContent = `現在の状態: ${statusText}`;
                            statusElem.className = `room-status ${statusClass}`;
                        }

                        // 全体の状況表示に部屋を追加
                        const roomDisplayDiv = document.createElement('div');
                        roomDisplayDiv.className = `room-display ${statusClass}`;
                        roomDisplayDiv.innerHTML = `<h3>部屋${room}</h3><p>${statusText.split(' ')[0]}</p>`; // 簡潔に表示
                        statusDisplaysContainer.appendChild(roomDisplayDiv);
                    });
                } else {
                    console.error('Failed to fetch room status:', data.message);
                    alert('部屋の状態の取得に失敗しました。');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert('部屋の状態の取得中に通信エラーが発生しました。');
            }
        }

        // ページ読み込み時に部屋の状態をロードする
        window.onload = fetchRoomStatus;
    </script>
</body>
</html>
