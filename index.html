// GAS Webアプリケーションのコード

// ★★★ あなたのスプレッドシートIDを直接記述します ★★★
const SPREADSHEET_ID = '1bv0FVC9tHVTfwEnzLMlZwflXa_oeibwGir1fArQpmr8'; 

const SHEET_NAME = 'シート1'; // 必要であればシート名を変更してください

/**
 * POSTリクエストを処理する関数（Webアプリケーションとして実行される）
 * Chrome拡張機能からデータを受け取ります。
 * @param {Object} e - イベントオブジェクト。POSTデータが含まれます。
 * @returns {GoogleAppsScript.Content.TextOutput} - JSON形式のレスポンス
 */
function doPost(e) {
  const responseOutput = ContentService.createTextOutput();
  responseOutput.setMimeType(ContentService.MimeType.JSON);

  const postDataContents = (e && e.postData) ? e.postData.contents : null;

  if (!postDataContents) {
    console.warn("doPostに空または無効なリクエストボディが届きました。イベントオブジェクト:", JSON.stringify(e));
    return createJsonResponse(false, "リクエストボディが空または無効です。", 400);
  }

  let data;
  try {
    data = JSON.parse(postDataContents);
  } catch (error) {
    console.error("JSONパースエラー:", error);
    return createJsonResponse(false, "リクエストボディのJSONパースに失敗しました。", 400);
  }

  const actionType = data.actionType; // アクションタイプをリクエストから取得

  // スプレッドシートIDが正しいか最終確認
  if (SPREADSHEET_ID !== '1bv0FVC9tHVTfwEnzLMlZwflXa_oeibwGir1fArQpmr8') {
     console.error("GASコード内のスプレッドシートIDが間違っています。");
     return createJsonResponse(false, "サーバー設定エラー: スプレッドシートIDが正しくありません。", 500);
  }

  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);

    if (!sheet) {
      return createJsonResponse(false, `シート名「${SHEET_NAME}」が見つかりません。`, 404);
    }

    if (actionType === 'enter') {
      const name = data.name;
      const room = data.room;
      const currentTime = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');

      if (!name || !room) {
        return createJsonResponse(false, "氏名、部屋番号は必須です。", 400);
      }
      
      sheet.appendRow([name, room, currentTime, '', '']);
      return createJsonResponse(true, `${name}様が${room}に入室しました。`);

    } else if (actionType === 'exit') {
      const name = data.name;
      const room = data.room;
      const currentTime = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');

      if (!name || !room) {
        return createJsonResponse(false, "氏名、部屋番号は必須です。", 400);
      }

      const dataRange = sheet.getDataRange();
      const values = dataRange.getValues();

      let foundRowIndex = -1;
      for (let i = values.length - 1; i >= 1; i--) {
        const row = values[i];
        if (row[0] === name && row[1] === room && (row[3] === '' || row[3] === undefined)) {
          foundRowIndex = i + 1;
          break;
        }
      }

      if (foundRowIndex !== -1) {
        sheet.getRange(foundRowIndex, 4).setValue(currentTime);
        return createJsonResponse(true, `${name}様が${room}から退室しました。`);
      } else {
        return createJsonResponse(false, `${name}様が${room}に入室中の記録が見つかりません。`);
      }
    } else if (actionType === 'getList') { // ★★★ 追加：参加者リスト取得アクション ★★★
        const dataRange = sheet.getDataRange();
        const values = dataRange.getValues(); // 全データを取得

        const activeParticipants = [];
        // ヘッダー行をスキップ (values[0]がヘッダー)
        for (let i = 1; i < values.length; i++) {
            const row = values[i];
            // 氏名(row[0]), 入室時刻(row[2]), 退室時刻(row[3])
            // 退室時刻が空欄であり、入室時刻がある場合、入室中と判断
            if (row[0] && row[2] && (row[3] === '' || row[3] === undefined)) {
                activeParticipants.push(row[0]); // 氏名を追加
            }
        }
        // participantsというキーで参加者リストを返します
        return createJsonResponse(true, "参加者リストを読み込みました。", 200, { participants: activeParticipants });
    } else {
      return createJsonResponse(false, "無効なアクションタイプです。", 400);
    }

  } catch (error) {
    if (error.message.includes("Can't find spreadsheet") || error.message.includes("Invalid argument: id")) {
      console.error("スプレッドシートが見つからないか、IDが無効です:", SPREADSHEET_ID, error);
      return createJsonResponse(false, `サーバー設定エラー: 指定されたスプレッドシートIDが無効か、見つかりません。`, 500);
    }
    console.error("スクリプト実行エラー:", error);
    return createJsonResponse(false, `サーバーエラーが発生しました: ${error.message}`, 500);
  }
}

/**
 * JSON形式のレスポンスを作成するヘルパー関数
 * optionalDataを引数として受け取り、JSONに含めるように変更しました。
 * @param {boolean} success - 処理が成功したかどうか
 * @param {string} message - ユーザーへのメッセージ
 * @param {number} statusCode - HTTPステータスコード (任意, GASでは直接設定できないがログ用)
 * @param {Object} optionalData - JSONレスポンスに含める追加のデータ (例: { participants: [...] })
 * @returns {GoogleAppsScript.Content.TextOutput}
 */
function createJsonResponse(success, message, statusCode = 200, optionalData = {}) {
  const json = JSON.stringify({ success: success, message: message, statusCode: statusCode, ...optionalData });
  return ContentService.createTextOutput(json)
                       .setMimeType(ContentService.MimeType.JSON);
}
